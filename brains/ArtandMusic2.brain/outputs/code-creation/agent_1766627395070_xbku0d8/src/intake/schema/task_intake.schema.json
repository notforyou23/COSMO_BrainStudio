{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://example.org/schemas/task_intake.schema.json",
  "title": "Intake Task (blocking validation)",
  "type": "object",
  "additionalProperties": true,
  "required": ["claim", "source", "provenance"],
  "properties": {
    "task_id": { "type": "string", "minLength": 1 },
    "created_at": { "type": "string", "format": "date-time" },
    "claim": {
      "type": "object",
      "additionalProperties": true,
      "required": ["verbatim"],
      "properties": {
        "verbatim": { "type": "string", "minLength": 1 },
        "language": { "type": "string", "minLength": 2 }
      }
    },
    "source": {
      "type": "object",
      "additionalProperties": true,
      "required": ["context"],
      "properties": {
        "context": { "type": "string", "minLength": 1 },
        "url": { "type": "string", "format": "uri" },
        "title": { "type": "string" },
        "publisher": { "type": "string" },
        "published_at": { "type": "string", "format": "date" },
        "captured_at": { "type": "string", "format": "date-time" }
      }
    },
    "provenance": {
      "type": "object",
      "additionalProperties": true,
      "required": ["anchor"],
      "properties": {
        "anchor": { "type": "string", "minLength": 1, "description": "Stable anchor e.g., URL+timestamp, archive link, screenshot hash, or citation key." },
        "notes": { "type": "string" }
      }
    },
    "doi": {
      "description": "Optional DOI for primary-source lookup; if missing, search.* fields become required.",
      "type": ["string", "null"],
      "minLength": 1
    },
    "search": {
      "type": "object",
      "additionalProperties": true,
      "properties": {
        "keywords": {
          "type": "array",
          "items": { "type": "string", "minLength": 1 },
          "minItems": 1
        },
        "authors": {
          "type": "array",
          "items": { "type": "string", "minLength": 1 },
          "minItems": 1
        },
        "date_range": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "start": { "type": "string", "format": "date", "default": "2019-01-01" },
            "end": { "type": "string", "format": "date", "default": "2025-12-31" }
          },
          "required": ["start", "end"],
          "default": { "start": "2019-01-01", "end": "2025-12-31" }
        }
      }
    }
  },
  "allOf": [
    {
      "if": {
        "anyOf": [
          { "not": { "required": ["doi"] } },
          { "properties": { "doi": { "type": "null" } }, "required": ["doi"] },
          { "properties": { "doi": { "type": "string", "maxLength": 0 } }, "required": ["doi"] }
        ]
      },
      "then": {
        "required": ["search"],
        "properties": {
          "search": {
            "required": ["keywords", "authors", "date_range"],
            "properties": {
              "date_range": {
                "properties": {
                  "start": { "default": "2019-01-01" },
                  "end": { "default": "2025-12-31" }
                },
                "default": { "start": "2019-01-01", "end": "2025-12-31" }
              }
            }
          }
        }
      }
    }
  ]
}
